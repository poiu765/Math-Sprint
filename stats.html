<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>내 기록</title>
  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#6b7280;
      --line:#e5e7eb;
      --card:#fafafa;
      --btn:#111111;
      --btnfg:#ffffff;
      --danger:#b91c1c;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      line-height:1.35;
    }
    .wrap{ max-width:980px; margin:0 auto; padding:20px; }
    h1{ margin:0; font-size:20px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      padding:10px 14px;
      border:1px solid var(--btn);
      background:var(--btn);
      color:var(--btnfg);
      border-radius:10px;
      font-size:15px;
      cursor:pointer;
      text-decoration:none;
      display:inline-block;
    }
    .btn.secondary{ background:#fff; color:var(--fg); border-color:var(--line); }
    .card{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:12px;
      padding:14px;
      margin-top:12px;
    }
    .small{ font-size:12px; color:var(--muted); }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    .answerRow{
      display:flex; gap:10px; margin-top:10px; align-items:stretch;
    }
    .answerRow input{
      flex:1;
      font-size:18px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
    }
    .problem{
      display:flex; align-items:center; justify-content:center;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:18px;
      min-height:72px;
      font-size:28px;
      font-weight:800;
      letter-spacing:.3px;
      user-select:none;
    }
    .choices{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
    }
    .choice-btn{
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
    }
    .choice-btn:active{ transform: translateY(1px); }
    .frac{
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      line-height:1;
      vertical-align:middle;
      margin:0 2px;
    }
    .frac .top{
      border-bottom:1px solid currentColor;
      padding:0 2px 2px;
      font-size:0.95em;
    }
    .frac .bottom{
      padding:2px 2px 0;
      font-size:0.95em;
    }
    .status{
      margin-top:8px; min-height:22px;
      font-size:13px; color:var(--muted);
    }
    .status.ok{ color:#047857; font-weight:700; }
    .status.bad{ color:#b91c1c; font-weight:700; }
    .btn.danger-muted{
      background:#f7d6d6;
      border-color:#f0b9b9;
      color:#8b1f1f;
    }
    .weak-list{
      margin:0; padding-left:0; list-style:none;
      display:flex; flex-direction:column; gap:6px;
    }
    .weak-item{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--line);
      border-radius:10px; background:#fff;
    }
    .weak-item label{ font-size:12px; color:var(--muted); }
    @media print{
      body{ background:#fff; }
      .btn, #logoutBtn, #practiceBtn, #practiceBox, #weakDeleteBtn, #weakSelectAllBtn, #weakPrintBtn{ display:none !important; }
      .card{ border:none; }
      #weakList .weak-item{ border:1px solid #ddd; }
    }
    .stat-grid{
      display:grid; gap:10px;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }
    @media (max-width: 900px){
      .stat-grid{ grid-template-columns: 1fr; }
    }
    .stat-op{ margin-bottom:12px; }
    .stat-title{ font-weight:800; margin-bottom:6px; }
    .stat-list{
      margin:0; padding-left:18px; font-size:12px; color:var(--muted);
    }
    .stat-list li{ margin-bottom:4px; }
    .select{
      padding:8px 10px; border:1px solid var(--line);
      border-radius:10px; background:#fff; font-size:14px;
    }
    .admin-grid{
      display:grid; gap:10px;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }
    @media (max-width: 900px){
      .admin-grid{ grid-template-columns: 1fr; }
    }
    .admin-list{
      margin:0; padding-left:18px; font-size:12px; color:var(--muted);
    }
    .admin-list li{ margin-bottom:4px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;">
      <h1>내 기록</h1>
      <div class="row">
        <a class="btn secondary" href="index.html">돌아가기</a>
        <button id="logoutBtn" class="btn secondary" type="button" disabled>로그아웃</button>
      </div>
    </div>

    <div class="card">
      <div class="small" id="authStatus">로그인 상태를 확인하는 중입니다.</div>
      <div class="small" id="statsEmpty" style="margin-top:8px;">로그인 후 내 기록을 볼 수 있습니다.</div>
      <div class="row" style="margin-top:8px;">
        <select id="filterOp" class="select">
          <option value="">단원 선택</option>
          <option value="add">덧셈</option>
          <option value="sub">뺄셈</option>
          <option value="mul">곱셈</option>
          <option value="div">나눗셈</option>
          <option value="trig">삼각함수</option>
        </select>
        <select id="filterLevel" class="select" disabled>
          <option value="">난이도 선택</option>
        </select>
      </div>
      <div id="statsBox" style="margin-top:8px;"></div>

      <div class="hr"></div>

      <div class="row" style="align-items:center; justify-content:space-between;">
        <div style="font-weight:800;">약점 연습</div>
        <button id="practiceBtn" class="btn" type="button">약점 연습 시작</button>
      </div>
      <div class="small" id="practiceHint" style="margin-top:6px;">
        틀린문제 또는 시간이 오래걸린 문제만 출제됩니다. 단원은 섞어서 나옵니다.
      </div>
      <div id="practiceBox" style="margin-top:10px; display:none;">
        <div class="problem" id="practiceProblem">—</div>
        <div id="practiceChoices" class="choices" style="display:none;"></div>
        <div class="answerRow">
          <input id="practiceInput" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="정답 입력" />
          <button id="practiceSubmit" class="btn" type="button">제출</button>
          <button id="practiceNext" class="btn secondary" type="button" disabled>다음</button>
        </div>
        <div class="status" id="practiceStatus"></div>
        <div class="small" id="practiceMeta"></div>
      </div>

      <div class="hr"></div>

      <div class="row" style="align-items:center; justify-content:space-between;">
        <div style="font-weight:800;">약점 관리</div>
        <div class="row">
          <button id="weakSelectAllBtn" class="btn secondary" type="button" disabled>전체선택</button>
          <button id="weakPrintBtn" class="btn secondary" type="button" disabled>인쇄</button>
          <button id="weakDeleteBtn" class="btn danger-muted" type="button" disabled>선택 삭제</button>
        </div>
      </div>
      <div class="small" id="weakEmpty" style="margin-top:6px;">삭제할 약점이 없습니다.</div>
      <ul class="weak-list" id="weakList" style="margin-top:8px;"></ul>
    </div>

    <div class="card" id="adminCard" style="display:none;">
      <div style="font-weight:800;">전체 데이터 (관리자 전용)</div>
      <div class="small" id="adminStatus" style="margin-top:6px;">데이터를 불러오는 중입니다.</div>
      <div id="adminBox" style="margin-top:8px;"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_UHGO2HW07NLlNlKyejzHOpCZPwm30TA",
      authDomain: "math-sprint-9c129.firebaseapp.com",
      projectId: "math-sprint-9c129",
      storageBucket: "math-sprint-9c129.firebasestorage.app",
      messagingSenderId: "358959824417",
      appId: "1:358959824417:web:21c328839c758c77b16d60",
      measurementId: "G-WTT3YC0BTW"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const ADMIN_EMAIL = "ghdwogus1284@gmail.com";

    const authStatus = document.getElementById("authStatus");
    const statsEmpty = document.getElementById("statsEmpty");
    const statsBox = document.getElementById("statsBox");
    const filterOp = document.getElementById("filterOp");
    const filterLevel = document.getElementById("filterLevel");
    const logoutBtn = document.getElementById("logoutBtn");
    const practiceBtn = document.getElementById("practiceBtn");
    const practiceBox = document.getElementById("practiceBox");
    const practiceProblem = document.getElementById("practiceProblem");
    const practiceInput = document.getElementById("practiceInput");
    const practiceSubmit = document.getElementById("practiceSubmit");
    const practiceNext = document.getElementById("practiceNext");
    const practiceStatus = document.getElementById("practiceStatus");
    const practiceMeta = document.getElementById("practiceMeta");
    const practiceChoices = document.getElementById("practiceChoices");
    const weakDeleteBtn = document.getElementById("weakDeleteBtn");
    const weakEmpty = document.getElementById("weakEmpty");
    const weakList = document.getElementById("weakList");
    const weakSelectAllBtn = document.getElementById("weakSelectAllBtn");
    const weakPrintBtn = document.getElementById("weakPrintBtn");
    const adminCard = document.getElementById("adminCard");
    const adminStatus = document.getElementById("adminStatus");
    const adminBox = document.getElementById("adminBox");

    let currentUserId = null;
    let practiceQueue = [];
    let currentWeak = null;
    let selectedWeak = new Set();
    let practiceTimer = null;
    let practiceEndAt = null;

    function opLabel(op){
      return op === "add" ? "덧셈" : op === "sub" ? "뺄셈" : op === "mul" ? "곱셈" : op === "div" ? "나눗셈" : "삼각함수";
    }
    function escapeHTML(str){
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }
    function formatMathHTML(text){
      const escaped = escapeHTML(String(text));
      return escaped.replace(/(π|√\d+|\d+)\s*\/\s*(\d+)/g, (_m, a, b) => {
        return `<span class="frac"><span class="top">${a}</span><span class="bottom">${b}</span></span>`;
      });
    }
    function compactProblem(text){
      return String(text).replace(/\s+/g, "").replace(/−/g, "-");
    }
    const levelMap = {
      add: ["(두자리,한자리)", "(두자리,두자리)", "(세자리,두자리)", "(세자리,세자리)"],
      sub: ["(두자리,한자리)", "(두자리,두자리)", "(세자리,두자리)", "(세자리,세자리)"],
      mul: ["(한자리,한자리)", "(두자리,한자리)", "(두자리,두자리)"],
      div: ["(두자리,한자리)", "(두자리,두자리)", "(세자리,한자리)", "(세자리,두자리)"],
      trig: ["(1단계)"]
    };
    function loadStats(uid){
      try{
        const raw = localStorage.getItem(`ms_stats_${uid}`);
        return raw ? JSON.parse(raw) : {};
      } catch(e){
        return {};
      }
    }
    function loadWeak(uid){
      try{
        const raw = localStorage.getItem(`ms_weak_${uid}`);
        return raw ? JSON.parse(raw) : { items: {} };
      } catch(e){
        return { items: {} };
      }
    }
    function saveWeak(uid, data){
      localStorage.setItem(`ms_weak_${uid}`, JSON.stringify(data));
    }
    function renderStats(uid){
      if(!uid){
        statsBox.innerHTML = "";
        statsEmpty.style.display = "block";
        return;
      }
      const op = filterOp.value;
      const lvl = filterLevel.value;
      if(!op || !lvl){
        statsBox.innerHTML = "";
        statsEmpty.style.display = "block";
        statsEmpty.textContent = "단원과 난이도를 선택해야 약점을 확인할 수 있습니다.";
        return;
      }
      const data = loadStats(uid);
      let html = "";
      const opData = data[op] || { wrong: [], slow: [] };
      const wrong = opData.wrong.filter(e => e.level === lvl).slice().reverse();
      const slow = opData.slow.filter(e => e.level === lvl).slice().reverse();
      html += `<div class="stat-op">`;
      html += `<div class="stat-title">${opLabel(op)} · ${lvl}</div>`;
      html += `<div class="stat-grid">`;
      html += `<div><div class="small" style="font-weight:700;">틀린문제</div><ul class="stat-list">`;
      if(wrong.length === 0){
        html += `<li>기록 없음</li>`;
      } else {
          wrong.forEach(e => {
            const ua = e.userAnswer === null || e.userAnswer === undefined ? "—" : e.userAnswer;
            html += `<li>${formatMathHTML(e.problem)} = ${formatMathHTML(e.answer)} (내 답: ${formatMathHTML(ua)}) · ${e.time.toFixed(1)}초</li>`;
          });
        }
      html += `</ul></div>`;
      html += `<div><div class="small" style="font-weight:700;">시간이 오래걸린 문제</div><ul class="stat-list">`;
      if(slow.length === 0){
        html += `<li>기록 없음</li>`;
      } else {
          slow.forEach(e => {
            const tag = e.result === "correct" ? "정답" : e.result === "timeout" ? "시간초과" : "오답";
            html += `<li>${formatMathHTML(e.problem)} · ${e.time.toFixed(1)}초 (${tag})</li>`;
          });
        }
      html += `</ul></div>`;
      html += `</div></div>`;
      statsBox.innerHTML = html;
      statsEmpty.style.display = "none";
    }

    async function renderAdminStats(){
      adminStatus.textContent = "데이터를 불러오는 중입니다.";
      adminBox.innerHTML = "";
      try{
        const snap = await db.collection("attempts")
          .orderBy("clientTs", "desc")
          .limit(2000)
          .get();
        const agg = {};
        snap.forEach(doc => {
          const d = doc.data();
          const op = d.op || "add";
          const key = `${d.problem} = ${d.answer}`;
          if(!agg[op]) agg[op] = {};
          if(!agg[op][key]) agg[op][key] = { correct:0, total:0, timeSum:0 };
          const row = agg[op][key];
          row.total += 1;
          if(d.result === "correct") row.correct += 1;
          row.timeSum += (typeof d.time === "number" ? d.time : 0);
        });

        const ops = ["add", "sub", "mul", "div", "trig"];
        let html = "";
        ops.forEach(op => {
          const opData = agg[op] || {};
          const entries = Object.entries(opData);
          if(entries.length === 0) return;
          html += `<div class="stat-op">`;
          html += `<div class="stat-title">${opLabel(op)}</div>`;
          html += `<div class="admin-grid">`;
          html += `<div><div class="small" style="font-weight:700;">문제별 정답률</div><ul class="admin-list">`;
          entries.forEach(([key, row]) => {
            const acc = row.total ? (row.correct / row.total * 100) : 0;
            html += `<li>${formatMathHTML(key)} · ${acc.toFixed(1)}% (${row.correct}/${row.total})</li>`;
          });
          html += `</ul></div>`;
          html += `<div><div class="small" style="font-weight:700;">문제별 풀이시간(평균)</div><ul class="admin-list">`;
          entries.forEach(([key, row]) => {
            const avg = row.total ? (row.timeSum / row.total) : 0;
            html += `<li>${formatMathHTML(key)} · ${avg.toFixed(1)}초</li>`;
          });
          html += `</ul></div>`;
          html += `</div></div>`;
        });
        adminBox.innerHTML = html || "<div class=\"small\">데이터가 없습니다.</div>";
        adminStatus.textContent = "";
      } catch(e){
        adminStatus.textContent = "데이터를 불러오지 못했습니다.";
      }
    }

    function formatDate(ts){
      const d = new Date(ts);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }
    function renderWeakList(uid){
      selectedWeak = new Set();
      if(!uid){
        weakList.innerHTML = "";
        weakEmpty.style.display = "block";
        weakDeleteBtn.disabled = true;
        weakSelectAllBtn.disabled = true;
        weakPrintBtn.disabled = true;
        return;
      }
      const data = loadWeak(uid);
      const items = Object.values(data.items || {});
      if(items.length === 0){
        weakList.innerHTML = "";
        weakEmpty.style.display = "block";
        weakDeleteBtn.disabled = true;
        weakSelectAllBtn.disabled = true;
        weakPrintBtn.disabled = true;
        return;
      }
      weakEmpty.style.display = "none";
      const rows = items.map(item => {
        const reasons = [];
        if(item.reasons && item.reasons.wrong) reasons.push("오답");
        if(item.reasons && item.reasons.slow) reasons.push("느림");
        const due = item.nextAt ? formatDate(item.nextAt) : "—";
        return `
          <li class="weak-item">
            <input type="checkbox" class="weak-check" data-id="${item.id}">
            <label>${formatMathHTML(compactProblem(item.problem))} · ${opLabel(item.op)} · ${item.level} · 다음: ${due} · ${reasons.join("/") || "약점"}</label>
          </li>
        `;
      });
      weakList.innerHTML = rows.join("");
      weakDeleteBtn.disabled = true;
      weakSelectAllBtn.disabled = false;
      weakPrintBtn.disabled = true;
    }

    function getDueWeak(uid){
      const data = loadWeak(uid);
      const now = Date.now();
      const items = Object.values(data.items || {});
      return items.filter(i => i.nextAt <= now);
    }
    function pickPracticeQueue(uid){
      const due = getDueWeak(uid);
      // shuffle
      for(let i = due.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        const t = due[i]; due[i] = due[j]; due[j] = t;
      }
      return due;
    }
    function showPracticeIdle(msg){
      clearPracticeTimer();
      practiceBox.style.display = "block";
      practiceProblem.textContent = "—";
      practiceStatus.className = "status";
      practiceStatus.textContent = msg || "약점 연습을 시작하세요.";
      practiceMeta.textContent = "";
      practiceChoices.style.display = "none";
      practiceInput.disabled = false;
      practiceSubmit.disabled = true;
      practiceNext.disabled = true;
    }
    function renderPracticeChoices(choices){
      practiceChoices.innerHTML = "";
      choices.forEach(val => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.type = "button";
        btn.innerHTML = formatMathHTML(val);
        btn.addEventListener("click", () => submitPracticeChoice(val));
        practiceChoices.appendChild(btn);
      });
    }
    function renderCurrentWeak(){
      if(!currentWeak){
        showPracticeIdle("오늘 풀 문제가 없습니다.");
        return;
      }
      practiceProblem.innerHTML = formatMathHTML(currentWeak.problem);
      practiceInput.value = "";
      practiceInput.focus();
      practiceStatus.className = "status";
      practiceStatus.textContent = "";
      const limit = typeof currentWeak.limit === "number" ? currentWeak.limit : 3.0;
      practiceMeta.textContent = `단원: ${opLabel(currentWeak.op)} · 난이도: ${currentWeak.level} · 제한 ${limit.toFixed(1)}초`;
      if(currentWeak.choices && currentWeak.choices.length){
        practiceChoices.style.display = "grid";
        renderPracticeChoices(currentWeak.choices);
        practiceSubmit.disabled = true;
        practiceInput.disabled = true;
      } else {
        practiceChoices.style.display = "none";
        practiceSubmit.disabled = false;
        practiceInput.disabled = false;
      }
      practiceNext.disabled = true;
      startPracticeTimer(limit);
    }
    function advanceWeak(item, correct){
      const data = loadWeak(currentUserId);
      const stored = data.items[item.id];
      if(!stored) return;
      const now = Date.now();
      const steps = [1, 3, 7];
      if(correct){
        const nextStage = Math.min((stored.stage || 0) + 1, 3);
        if(nextStage >= 3){
          delete data.items[item.id];
          saveWeak(currentUserId, data);
          return;
        }
        const days = steps[Math.min(nextStage - 1, steps.length - 1)];
        stored.stage = nextStage;
        stored.nextAt = now + days * 24 * 60 * 60 * 1000;
        stored.lastResult = "correct";
      } else {
        stored.stage = 0;
        stored.nextAt = now;
        stored.lastResult = "wrong";
      }
      stored.lastTs = now;
      data.items[item.id] = stored;
      saveWeak(currentUserId, data);
    }
    function nextPractice(){
      currentWeak = practiceQueue.shift() || null;
      renderCurrentWeak();
    }
    function submitPracticeChoice(val){
      if(!currentWeak) return;
      clearPracticeTimer();
      const isCorrect = val === currentWeak.answer;
      if(isCorrect){
        practiceStatus.className = "status ok";
        practiceStatus.textContent = "정답!";
      } else {
        practiceStatus.className = "status bad";
        practiceStatus.textContent = `오답! 정답은 ${currentWeak.answer}`;
      }
      advanceWeak(currentWeak, isCorrect);
      practiceNext.disabled = false;
      renderStats(currentUserId);
      renderWeakList(currentUserId);
    }

    function clearPracticeTimer(){
      if(practiceTimer){ clearInterval(practiceTimer); practiceTimer = null; }
      practiceEndAt = null;
    }
    function startPracticeTimer(limitSec){
      clearPracticeTimer();
      practiceEndAt = Date.now() + limitSec * 1000;
      practiceTimer = setInterval(() => {
        const leftMs = practiceEndAt - Date.now();
          if(leftMs <= 0){
            clearPracticeTimer();
            if(currentWeak){
              practiceStatus.className = "status bad";
              practiceStatus.textContent = `시간초과! 정답은 ${currentWeak.answer}`;
              practiceInput.value = "";
              advanceWeak(currentWeak, false);
              practiceSubmit.disabled = true;
              practiceNext.disabled = false;
              renderStats(currentUserId);
            renderWeakList(currentUserId);
          }
        }
      }, 120);
    }

    logoutBtn.addEventListener("click", async () => {
      await auth.signOut();
    });

    practiceBtn.addEventListener("click", () => {
      practiceBox.style.display = "block";
      if(!currentUserId){
        showPracticeIdle("로그인 후 약점 연습을 사용할 수 있습니다.");
        return;
      }
      practiceQueue = pickPracticeQueue(currentUserId);
      if(practiceQueue.length === 0){
        showPracticeIdle("오늘 풀 문제가 없습니다.");
        return;
      }
      practiceBox.style.display = "block";
      nextPractice();
    });

    practiceSubmit.addEventListener("click", () => {
      if(!currentWeak) return;
      if(currentWeak.choices && currentWeak.choices.length) return;
      const raw = practiceInput.value.trim();
      if(raw === "") return;
      const userAns = parseInt(raw, 10);
      if(Number.isNaN(userAns)) return;
      clearPracticeTimer();
      const isCorrect = userAns === currentWeak.answer;
      if(isCorrect){
        practiceStatus.className = "status ok";
        practiceStatus.textContent = "정답!";
      } else {
        practiceStatus.className = "status bad";
        practiceStatus.textContent = `오답! 정답은 ${currentWeak.answer}`;
      }
      advanceWeak(currentWeak, isCorrect);
      practiceSubmit.disabled = true;
      practiceNext.disabled = false;
      renderStats(currentUserId);
      renderWeakList(currentUserId);
    });

    practiceNext.addEventListener("click", () => {
      clearPracticeTimer();
      if(practiceQueue.length === 0){
        currentWeak = null;
        showPracticeIdle("오늘 풀 문제가 없습니다.");
      } else {
        nextPractice();
      }
    });

    practiceInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !practiceSubmit.disabled){
        e.preventDefault();
        practiceSubmit.click();
      }
    });

    function populateLevelOptions(){
      const op = filterOp.value;
      filterLevel.innerHTML = "<option value=\"\">난이도 선택</option>";
      if(!op){
        filterLevel.disabled = true;
        return;
      }
      (levelMap[op] || []).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        filterLevel.appendChild(opt);
      });
      filterLevel.disabled = false;
    }
    filterOp.addEventListener("change", () => {
      populateLevelOptions();
      renderStats(currentUserId);
    });
    filterLevel.addEventListener("change", () => {
      renderStats(currentUserId);
    });

    weakList.addEventListener("change", (e) => {
      const target = e.target;
      if(!target.classList.contains("weak-check")) return;
      const id = target.getAttribute("data-id");
      if(target.checked){
        selectedWeak.add(id);
      } else {
        selectedWeak.delete(id);
      }
      weakDeleteBtn.disabled = selectedWeak.size === 0;
      weakPrintBtn.disabled = selectedWeak.size === 0;
    });

    weakSelectAllBtn.addEventListener("click", () => {
      const checks = weakList.querySelectorAll(".weak-check");
      if(checks.length === 0) return;
      const allChecked = Array.from(checks).every(c => c.checked);
      selectedWeak = new Set();
      checks.forEach(c => {
        c.checked = !allChecked;
        if(c.checked){
          selectedWeak.add(c.getAttribute("data-id"));
        }
      });
      weakDeleteBtn.disabled = selectedWeak.size === 0;
      weakPrintBtn.disabled = selectedWeak.size === 0;
    });

    weakPrintBtn.addEventListener("click", () => {
      const checks = weakList.querySelectorAll(".weak-check");
      const selected = [];
      checks.forEach(c => {
        if(c.checked){
          const li = c.closest(".weak-item");
          if(li){
            const label = li.querySelector("label");
            selected.push(label ? label.innerHTML : li.innerHTML);
          }
        }
      });
      if(selected.length === 0) return;

      const html = `
        <!doctype html>
        <html lang="ko">
        <head>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <title>약점 인쇄</title>
          <style>
            body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin:20px; }
            h1{ font-size:18px; margin:0 0 10px; }
            ul{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; }
            li{ border:1px solid #ddd; border-radius:10px; padding:8px 10px; font-size:12px; }
            .frac{
              display:inline-flex; flex-direction:column; align-items:center; line-height:1; vertical-align:middle; margin:0 2px;
            }
            .frac .top{ border-bottom:1px solid currentColor; padding:0 2px 2px; font-size:0.95em; }
            .frac .bottom{ padding:2px 2px 0; font-size:0.95em; }
          </style>
        </head>
        <body>
          <h1>선택한 약점</h1>
          <ul>
            ${selected.map(s => `<li>${s}</li>`).join("")}
          </ul>
        </body>
        </html>
      `;

      const w = window.open("", "_blank");
      if(!w) return;
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
      w.close();
    });

    weakDeleteBtn.addEventListener("click", () => {
      if(!currentUserId || selectedWeak.size === 0) return;
      const data = loadWeak(currentUserId);
      selectedWeak.forEach(id => {
        delete data.items[id];
      });
      saveWeak(currentUserId, data);
      renderWeakList(currentUserId);
      practiceQueue = [];
      currentWeak = null;
      showPracticeIdle("약점이 삭제되었습니다.");
    });

    auth.onAuthStateChanged((user) => {
      if(user){
        const label = user.displayName || user.email || "로그인됨";
        authStatus.textContent = `로그인됨: ${label}`;
        logoutBtn.disabled = false;
        currentUserId = user.uid;
        renderStats(user.uid);
        renderWeakList(user.uid);
        showPracticeIdle("약점 연습을 시작하세요.");
        populateLevelOptions();
        if(user.email === ADMIN_EMAIL){
          adminCard.style.display = "block";
          renderAdminStats();
        } else {
          adminCard.style.display = "none";
        }
      } else {
        authStatus.textContent = "로그인하지 않으면 기록을 볼 수 없습니다.";
        logoutBtn.disabled = true;
        currentUserId = null;
        renderStats(null);
        renderWeakList(null);
        showPracticeIdle("로그인 후 약점 연습을 사용할 수 있습니다.");
        adminCard.style.display = "none";
      }
    });
  </script>
</body>
</html>
